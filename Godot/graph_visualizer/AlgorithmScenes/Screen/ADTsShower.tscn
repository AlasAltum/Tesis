[gd_scene load_steps=4 format=2]

[ext_resource path="res://AlgorithmScenes/Screen/Assets/arrow_right.png" type="Texture" id=3]
[ext_resource path="res://AlgorithmScenes/Screen/Assets/arrow_left.png" type="Texture" id=4]

[sub_resource type="GDScript" id=1]
script/source = "class_name ADTShower
extends PanelContainer

# Displays a Window Dialog that shows a visual representation
# of each variable in the stack 
# This class may be a: QueueRepresentation, StackRepresentation
var current_adt: ADTRepresentation
var stored_adts: Array = []
var name_to_representation: Dictionary = {}
var selected_variable_index: int = 0
var debug_block: DebugBlock

onready var variable_name_label: Label = $VBoxContainer/VarNameLabel


func _ready() -> void:
	StoredData.adt_shower = self
	debug_block = StoredData.debug_block

#func _on_ADTStructureButton_pressed() -> void:
#	self.popup()

func set_name_of_label(var_name: String):
	variable_name_label.text = \"Current variable: \" + var_name

func _input(event):
	if event.is_action_pressed(\"left\"):
		_on_LeftButton_pressed()
	elif event.is_action_pressed(\"right\"):
		_on_RightButton_pressed()


func hide_current_representatation():
	if current_adt and is_instance_valid(current_adt):
		current_adt.visible = false  # make the previous adt invisible

# This method assumes the selected variable index was changed previously
func _update_shown_adt_after_index_change():
	hide_current_representatation()
	current_adt = stored_adts[self.selected_variable_index]

	if current_adt:
		# TODO: BUG with selected variable index after u is created
		debug_block.change_focus_of_label(self.selected_variable_index)
		set_name_of_label(debug_block.map_int_to_name[selected_variable_index])
		current_adt.visible = true  # make the previous adt invisible

func _on_LeftButton_pressed() -> void:
	_on_variable_index_down()

func _on_variable_index_down():
	if debug_block.labels.size() > 1:
		self.selected_variable_index = (self.selected_variable_index - 1) % debug_block.labels.size()
		# Since modulo % may render negative results, use an if to have circularity
		if self.selected_variable_index == -1:
			self.selected_variable_index = debug_block.labels.size() - 1
		_update_shown_adt_after_index_change()


func _on_RightButton_pressed() -> void:
	_on_variable_index_up()


func _on_variable_index_up():
	if debug_block.labels.size() > 1:
		self.selected_variable_index = (self.selected_variable_index + 1) % debug_block.labels.size()
		_update_shown_adt_after_index_change()

func update_representation(var_name, data):
	if StoredData.has_variable(var_name):
		self.erase_representation(var_name)
	self.add_representation(var_name, data)

# Create a new representation given a variable name and new data
func add_representation(var_name, data) -> void:
	# One of: NodeRepresentation, QueueRepresentation, StackRepresentation 
	var representation: ADTRepresentation = data.create_representation()
	# Position may change according to the scene. Each ADT should have
	# a initial position method to set it.
	representation.position = representation.get_initial_position()
	# representation.set_properties() # if we want additional configuration	
	stored_adts.append(representation)
	name_to_representation[var_name] = representation
	$VBoxContainer/Container.add_child(representation)
	representation.visible = false

#   TODO: Check if this is a good option
#	# Show the new added representation
#	self.selected_variable_index = stored_adts.find_last(representation)
#
#	if self.stored_adts.size() > 1:
#		call_deferred(\"_update_shown_adt_after_index_change\")
#		representation.visible = true
#		self.current_adt = representation



func erase_representation(var_name) -> void:
	# TODO: if current representation is this, change index
	# and check visibility
	var adt_representation: ADTRepresentation = name_to_representation[var_name]
	stored_adts.erase(adt_representation)
	name_to_representation.erase(var_name)
	adt_representation.queue_free()

 
## Add Node to ADT representation
#func _add_node(node: AGraphNode) -> void:
#	stored_adts.append(node)
#	current_adt._add_node(node)


## Remove Node from ADT representation
#func _remove_node(node: AGraphNode) -> void:
#	stored_adts.erase(node)
#	current_adt._remove_node(node)


"

[node name="ADTsShower" type="WindowDialog"]
visible = true
anchor_left = 0.5
anchor_top = 0.5
anchor_right = 0.5
anchor_bottom = 0.5
margin_left = -634.854
margin_top = -200.771
margin_right = 103.146
margin_bottom = 108.229
window_title = "ADT Representations"
script = SubResource( 1 )
__meta__ = {
"_edit_use_anchors_": false
}

[node name="Panel" type="Panel" parent="."]
anchor_left = 0.1
anchor_top = 0.2
anchor_right = 0.9
anchor_bottom = 0.8
margin_left = -19.0425
margin_top = -20.0
margin_right = 20.9575
margin_bottom = 20.0
size_flags_horizontal = 3
size_flags_vertical = 3
__meta__ = {
"_edit_use_anchors_": false
}

[node name="VarNameLabel" type="Label" parent="."]
margin_left = 56.0695
margin_top = 11.9871
margin_right = 173.069
margin_bottom = 36.9871
text = "Current variable: q"
__meta__ = {
"_edit_use_anchors_": false
}

[node name="LeftButton" type="TextureButton" parent="."]
self_modulate = Color( 1, 1, 1, 0.392157 )
margin_left = 58.0656
margin_top = 112.127
margin_right = 215.066
margin_bottom = 344.127
rect_scale = Vector2( 0.2, 0.2 )
texture_normal = ExtResource( 4 )
__meta__ = {
"_edit_use_anchors_": false
}

[node name="RightButton" type="TextureButton" parent="."]
self_modulate = Color( 1, 1, 1, 0.392157 )
margin_left = 647.0
margin_top = 111.855
margin_right = 804.0
margin_bottom = 343.855
rect_scale = Vector2( 0.2, 0.2 )
texture_normal = ExtResource( 3 )
__meta__ = {
"_edit_use_anchors_": false
}

[connection signal="pressed" from="LeftButton" to="." method="_on_LeftButton_pressed"]
[connection signal="pressed" from="RightButton" to="." method="_on_RightButton_pressed"]
